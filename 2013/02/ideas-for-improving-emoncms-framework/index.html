<!doctype html>
  <!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
  <!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
  <!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
  <!--[if gt IE 8]><!--> <html> <!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Ideas for improving the emoncms framework - Blog | OpenEnergyMonitor</title>
    <meta name="author" content="Glyn Hudson">
    <meta name="description" content="OpenEnergyMonitor Blog">
    
    <meta name="viewport" content="width=device-width">
    <link rel="canonical" href="https://blog.openenergymonitor.org/2013/02/ideas-for-improving-emoncms-framework/">

    <meta property="fb:app_id" content="">
    <meta property="og:title" content="Ideas for improving the emoncms framework">
    <meta property="og:site_name" content="Blog | OpenEnergyMonitor">
    <meta property="og:url" content="https://blog.openenergymonitor.org/2013/02/ideas-for-improving-emoncms-framework/">
    <meta property="og:type" content="article">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@openenergymon">
    
    <meta name="twitter:title" content="Ideas for improving the emoncms framework">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet">
    <link href="/atom.xml" rel="alternate" title="Blog | OpenEnergyMonitor" type="application/atom+xml">
    <link rel='shortcut icon' href='/images/favicon.ico' />
    <link rel='icon' type='image/png' href='/images/favicon-192x192.png' sizes='192x192' />
    
    
    
    <link rel="shortcut icon" href="/favicon.ico">
	<link rel="icon" sizes="16x16 32x32 64x64" href="/favicon.ico">
	<link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-192.png">
	<link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96.png">
	<link rel="icon" type="image/png" sizes="64x64" href="/images/favicon-64.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
	<link rel="apple-touch-icon" href="/images/favicon-57.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/favicon-114.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/favicon-72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/images/favicon-144.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/images/favicon-60.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/images/favicon-120.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/images/favicon-76.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/images/favicon-152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-180.png">
	<meta name="msapplication-TileColor" content="#FFFFFF">
	<meta name="msapplication-TileImage" content="/images/favicon-144.png">
	<meta name="msapplication-config" content="/images/browserconfig.xml">
	
  </head>

  <body >

    <header>
      <div class="grid-wrapper">
  <div class="grid">

    <div class="grid__item three-tenths lap-two-sixths palm-one-whole ha-title">
  <a href="/" class="site-title">
    <!--<img width='40' src='/images/favicon-192x192.png'> -->
    
    <span style="color:#777;font-weight:bold;font-family:Arial;font-size:20"'>
Open</span><span style="color:#44b3e2;font-weight:bold;font-family:Arial;font-size:20"'>EnergyMonitor</span>

  </a>
</div>

<div class="grid__item seven-tenths lap-four-sixths palm-one-whole">
  <nav>
    <input type="checkbox" id="toggle">
<label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu"></label>
<ul class="menu pull-right">
  <li><a href="https://openenergymonitor.org">Main Site</a></li>
  <li><a href="https://guide.openenergymonitor.org">User Guide</a></li>
  <li><a href="https://emoncms.org">Emoncms</a></li>
  <li><a href="https://community.openenergymonitor.org">Community</a></li>
  <li><a href="https://shop.openenergymonitor.com    ">Shop<i class="icon icon-shopping-cart"></i></a></li>
</ul>
  </nav>
</div>

  </div>
</div>
    </header>

    

    <div class="grid-wrapper">
      <div class="grid grid-center">
        
        <div class="grid__item two-thirds lap-one-whole palm-one-whole">
        

          <article class="post">
  <div class='edit-github'><a href='https://github.com/openenergymonitor/blog/tree/master/source/_posts/2013-02-09-ideas-for-improving-emoncms-framework.html'>Edit on GitHub</a></div>
<div class='edit-github'><a href='http://prose.io/#openenergymonitor/blog/edit/master/source/_posts/2013-02-09-ideas-for-improving-emoncms-framework.html'>Edit on GitHub Prose</a></div>
  
  <header>
  
  <h1 class="title indent">Ideas for improving the emoncms framework</h1>
  

  
  <div class="meta clearfix">
    <time datetime="2013-02-09T18:53:00+00:00" pubdate data-updated="true"><i class="icon-calendar"></i> 2013-02-09 18:53:00 +00002013-02-09 18:53:00 +0000
    <span class="byline author vcard"><i class='icon-user'></i> Trystan Lea</span> <br>
    <span><i class='icon-time'></i> seven minutes reading time</span> <br>
    <span>
    <i class="icon-tags"></i>
    <ul class="tags unstyled">
    
      
        <li><a class='category' href='/categories/emoncms/'>emoncms</a></li>
      
    
    </ul>
  </span> <br>
    
      <a class='comments'
         href="/2013/02/ideas-for-improving-emoncms-framework/#disqus_thread"
         >Comments</a>
    
  </div>
  
</header>


  I've been looking again at writing&nbsp;the developer documentation for emoncms, in particular Id like to document how to build the core framework from scratch, explaining the design decisions and implementation of things like the front controller, modules folder structure, MVC pattern.<br /><br />In doing this exercise and reading up more widely about the various parts I started to get ideas for improvements.<br /><h3>1) Changing the controller structure to better reflect the client side javascript nature of views</h3>The first insight I had followed from reading Jean Claude Wipplers post about really going all the way with client side javascript (and server side for that matter :)&nbsp;using&nbsp;angular js and other technologies: <a href="http://jeelabs.org/2013/01/07/technology-decisions/">http://jeelabs.org/2013/01/07/technology-decisions/</a>&nbsp;"...Think about the change in mindset: no server-side templatingâ€¦ n o n e !"<br /><br />Emoncms UI is already largely client-side javascript with javascript making 41% of the emoncms code base. But there are still quite a few parts that are generated by server-side templating - the user account page being one notable example.<br /><br />The framework was initially built with server side templating in mind with the result of the model being passed to a view and the view being constructed with php. The current <a href="http://openenergymonitor.org/emon/node/312">emoncms application architecture</a> documentation page reflects this idea, see the Views section in&nbsp;particular&nbsp;which shows a minimal example of creating a feed list using php.<br /><br />However the way the feed list view is actually made in emoncms is using client side javascript to create a dynamic view that shows the feeds updating in realtime. The feed list data is requested from the server using jquery AJAX every 5 seconds.<br /><br />Letting go of the idea that we might want to do server side php templating for most of the module views and&nbsp;reassessing&nbsp;the framework controller code in particular, the following as described on the controller part of the application architecture page no longer makes much sense:<br /><br />if ($action == 'list' &amp;&amp; $_SESSION['read'])<br />{<br />&nbsp; $feeds = get_user_feeds($_SESSION['userid']);<br /><br />&nbsp; if ($format == 'json') $output = json_encode($feeds);<br />&nbsp; if ($format == 'html') $output = view("feed/list_view.php", array('feeds' =&gt; $feeds));<br />}<br /><br />Here in&nbsp;response&nbsp;to a request from the client for a feed list we first get the data from the model and second either output it as json or wrap it in a view. But if the view no longer needs the feeds array passed to it (as it is getting the feeds data via an AJAX request) it makes no sense for the view to be called after getting the data from the model.<br /><br />So I think a clearer structure for the controller is to divide it into two parts:<br /><br />The first part deals with html page requests and is essentially loading the client side application from the server to the client:<br /><br />if ($format == 'html')<br />{<br />&nbsp; if ($action == 'list') $output = view("feed/list_view.php", array());<br />&nbsp; if ($action == 'view') ...<br />}<br /><br />The second part placed directly below the above in the controller deals with the JSON API to the model<br /><br />if ($format == 'json')<br />{<br />&nbsp; if ($action == 'get') $result = get_feed(get('userid'),get('feedid'));<br />&nbsp; if ($action == 'list') $result = get_user_feeds(get('userid'));<br /><br />&nbsp; $output = json_encode($result);<br />}<br /><div><h3>2) Straight mysqli instead of db.php abstraction</h3>While rewriting the core framework from scratch it hit me that the db.php abstraction I created that converts mysqli class calls into global scope db_query etc functions is not really that useful and probably just confusing. db.php never did anything  useful on top of mysqli like input sanitisation or anything like that so I think it would just be better to write straight mysqli.<br /><br />Which leads on to the next point:<br /><h3>3) Models as classes</h3>After using the mysqli class with the $mysqli-&gt;query() $class-&gt;method() type interface I started to experiment with using php classes for the emoncms models instead of just a file full of functions. Here's an example for the feed class with only one method for loading a users feed list (notice also how $mysqli is passed into the class for use)<br /><br />class Feed<br />{  <br />&nbsp; private $mysqli;<br /><br />&nbsp; public function __construct($mysqli)<br />&nbsp; {<br />&nbsp; &nbsp; $this-&gt;mysqli = $mysqli;<br />&nbsp; }<br /><br />&nbsp; public function list($userid)<br />&nbsp; {    <br />&nbsp; &nbsp; $feeds = array();<br />&nbsp; &nbsp; $result = $this-&gt;mysqli-&gt;query("SELECT * FROM feeds WHERE `userid` = '$userid');<br />&nbsp; &nbsp; while ($row = $result-&gt;fetch_object()) $feeds[] = $row;<br />&nbsp; &nbsp; return $feeds;<br />&nbsp; }<br /><br />}<br /><br />To use this in the application we first create an instance of the class<br /><br />$feed = new Feed($mysqli);<br /><br />and then call the methods needed:<br /><br />$result = $feed-&gt;list($userid);<br /><br />This gives us a nice interface to the feed model in the rest of the application, it's a clearer naming convention model_name-&gt;method_name() and its clearer that model methods and&nbsp;properties belong to that model. There are also a whole load of other potential benefits as time goes on such as extending the class and so on (all standard stuff in most frameworks)<br /><h3>4) The fat model and thin controller</h3>In reading more on the model view controller pattern I came across this article which really made a lot of sense to me: <a href="http://blog.astrumfutura.com/2008/12/the-m-in-mvc-why-models-are-misunderstood-and-unappreciated/">http://blog.astrumfutura.com/2008/12/the-m-in-mvc-why-models-are-misunderstood-and-unappreciated/</a><br /><br />The question of what should be in the controller and what should be in the model is something that I had been a bit unsure about and so far I have usually put input validation and any error reporting in the controller while trying to confine the model to primarily data access.&nbsp;</div><div><br /></div><div>But looking again at this and with the clarity of that article, it makes sense to me that input validation and error reporting should be in the model instead.</div><div><br /></div><div>When coupled with the class based model that model then becomes a very complete and portable class that can be used in different applications or frameworks&nbsp;as the article suggests&nbsp;with all the validation and error reporting intact.<br /><br />The controller's role then becomes:&nbsp;translation of the external http api to model method calls , fetching of input via $_GET and $_POST and passing these to the model method&nbsp;parameters&nbsp;and checking to see if the user has the correct&nbsp;privileges&nbsp;to call the model method.<br /><h3>5) php code formatting standards&nbsp;</h3><div>Here's another interesting resource I came across only yesterday&nbsp;<a href="http://phptherightway.com/">phptherightway.com</a>.&nbsp;There's lots of valuable information on there including details on 4 standards including a code formatting standard for php produced by many of the large php frameworks and application projects, I think it would be good to adopt these in emoncms.</div><div><div><h3><b>On the client&nbsp;</b></h3><div><h3>6) Move all the user interfaces over to client side javascript</h3>As&nbsp;mentioned&nbsp;above emoncms user interfaces are already largely constructed with client side javascript interacting with the server via AJAX requests but there are still several interfaces like the user account page that are constructed using php templating. I'd like to explore ways of modularising the client side code, making the code as clear as possible, it all gets rather complex and a bit messy there pretty fast at the moment. I'm also intrigued to explore AngularJS which Jean Claude Wippler <a href="http://jeelabs.org/2012/12/22/dynamic-web-pages/">is using</a> as that looks like it might be a solution to some of the javascript jquery complexity woes that I have been having.</div><div><h3>Next steps...</h3>One of the good things about the server side changes proposed above is that many of them are only minor changes to&nbsp;existing&nbsp;code and they can be introduced incrementally, so we can run old code alongside new.</div></div></div><div><br /></div><div>My plan is to start by completing the emoncms architecture documentation: how to build the emoncms framework from scratch then go on to convert the user module over to the controller and model design as detailed above and complete a nice javascript enabled user login/register page and a user account and profile page.</div><div><br /></div><div><br /></div></div>
      <b>To engage in discussion regarding this post, please post on our <a href="http://community.openenergymonitor.org">Community Forum</a></b>.
    <br>
</article>



        </div>

        
        <aside id="sidebar" class="grid__item one-third lap-one-whole palm-one-whole">
          <div class="grid">

 
 <section id="recent-posts" class="aside-module grid__item one-whole lap-one-half">
  <h1 class="title delta">Recent Posts</h1>
  <ul class="divided">
    
      
        <li class="post">
          <a href="/2017/01/openevse-build/">OpenEVSE EV Charge Controller</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/09/emonth2/">Introducing emonTH V2</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/09/summer-placement/">Summer Placement</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/08/ecohomelab-control/">EcoHome Lab: From Monitoring to Control</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/07/HTU21D-Temperature-Humidity-sensor/">HTU21D / Si72021 Temperature and Humidity Sensor</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/esp8266-ota-update/">Part 3/3: Continuous Deployment (Over-The-Air Update to ESP8266)</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/emoncms-docker/">Emoncms Docker</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/esp8266-emonesp-developments/">ESP8266 WIFI developments</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/auto-build-continuous-test-firmware/">Part 2/3: Firmware Continuous Test & Build</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/platformio/">Part 1/3: PlatformIO open-source embedded development ecosystem</a>
        </li>
      
    
  </ul>
</section>
  
  
</div>
        </aside>
        
      </div>
    </div>

    <footer>
      <div class="grid-wrapper">
  <div class="grid">
    <div class="grid__item">
      <style>


div.searchtool {
  position: relative;
  display: inline-block;
  top: -6px;
}

input[type=text] {
  border: 3px solid #44b3e2;
}

fieldset {
  border: 0;
}

</style>
<div class="copyright">

  <a rel="me" href='https://twitter.com/openenergymon'><i class="icon-twitter"></i></a>
  <a rel="me" href='https://github.com/openenergymonitor/guide'><i class="icon-github"></i></a>
  <a rel="me" href='https://blog.openenergymonitor.org/feed.xml'><i class="icon-rss"></i></a>

  <div class="credit">
    Website powered by <a href='http://jekyllrb.com/'>Jekyll</a> and <a href='https://github.com/coogie/oscailte'>Oscalite</a>.<br />
    Hosted by <a href='https://pages.github.com/'>GitHub</a> and served by <a href='https://cloudflare.com'>CloudFlare</a>.
  </div>

<div class="searchtool">


<form action="https://encrypted.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.openenergymonitor.org" />
    <input class="search" id="search" type="text" name="q" results="0" placeholder="Search..." />
  </fieldset>
</form>


</div>
</div>
    </div>
  </div>
</div>
    </footer>

    <!--[if lt IE 7]>
      <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <script>
  var _gaq=[['_setAccount','UA-10321170-4'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
<script>
  var disqus_shortname = 'openenergymonitor';
  
    
    var disqus_script = 'count.js';
  
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


<script>
  $(document).ready(function(){
    if (!window.jXHR){
      var jxhr = document.createElement('script');
      jxhr.type = 'text/javascript';
      jxhr.src = '/javascripts/libs/jXHR.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jxhr, s);
    }

    github.showRepos({
      user: 'openenergymonitor',
      count: 5,
      skip_forks: true,
      target: '#gh_repos'
    });
  });
</script>
<script src="/javascripts/github.js"></script>

  </body>
</html>